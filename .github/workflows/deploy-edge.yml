name: Deploy to Edge Add-ons Store

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes for this version'
        required: true
        default: 'Bug fixes and improvements'
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build Edge extension
        run: bun run build:edge

      - name: Zip Edge extension
        run: bun run zip:edge

      - name: Find Edge zip file
        id: find_edge_zip
        run: |
          EDGE_ZIP=$(ls .output/edge-mv*.zip 2>/dev/null | head -1)
          if [ -z "$EDGE_ZIP" ]; then
            echo "Error: Edge zip file not found"
            exit 1
          fi
          echo "edge_zip=$EDGE_ZIP" >> $GITHUB_OUTPUT
          echo "Edge zip: $EDGE_ZIP"

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload package to Edge Add-ons Store
        id: upload_package
        run: |
          API_ENDPOINT="https://api.addons.microsoftedge.microsoft.com"
          PRODUCT_ID="${{ secrets.EDGE_PRODUCT_ID }}"
          CLIENT_ID="${{ secrets.EDGE_CLIENT_ID }}"
          API_KEY="${{ secrets.EDGE_API_KEY }}"
          ZIP_FILE="${{ steps.find_edge_zip.outputs.edge_zip }}"
          
          echo "Uploading package to Edge Add-ons Store..."
          # Use -i to include headers, -w to append HTTP code
          UPLOAD_RESPONSE=$(curl -i -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST \
            -H "Authorization: ApiKey $API_KEY" \
            -H "X-ClientID: $CLIENT_ID" \
            -H "Content-Type: application/zip" \
            --data-binary "@$ZIP_FILE" \
            "$API_ENDPOINT/v1/products/$PRODUCT_ID/submissions/draft/package")
          
          HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          LOCATION_HEADER=$(echo "$UPLOAD_RESPONSE" | grep -i "^location:" | cut -d' ' -f2 | tr -d '\r\n')
          
          if [ "$HTTP_CODE" != "202" ]; then
            echo "Upload failed with HTTP code: $HTTP_CODE"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          fi
          
          # Extract operation ID from Location header
          if [ -z "$LOCATION_HEADER" ]; then
            echo "Failed to extract Location header from response"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          fi
          
          OPERATION_ID=$(echo "$LOCATION_HEADER" | sed 's/.*\/\([^\/]*\)$/\1/')
          if [ -z "$OPERATION_ID" ]; then
            echo "Failed to extract operation ID from Location header: $LOCATION_HEADER"
            exit 1
          fi
          
          echo "operation_id=$OPERATION_ID" >> $GITHUB_OUTPUT
          echo "Upload successful. Operation ID: $OPERATION_ID"

      - name: Check package upload status
        id: check_upload_status
        run: |
          API_ENDPOINT="https://api.addons.microsoftedge.microsoft.com"
          PRODUCT_ID="${{ secrets.EDGE_PRODUCT_ID }}"
          CLIENT_ID="${{ secrets.EDGE_CLIENT_ID }}"
          API_KEY="${{ secrets.EDGE_API_KEY }}"
          OPERATION_ID="${{ steps.upload_package.outputs.operation_id }}"
          
          echo "Checking upload status..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          RETRY_DELAY=5
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            STATUS_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X GET \
              -H "Authorization: ApiKey $API_KEY" \
              -H "X-ClientID: $CLIENT_ID" \
              "$API_ENDPOINT/v1/products/$PRODUCT_ID/submissions/draft/package/operations/$OPERATION_ID")
            
            HTTP_CODE=$(echo "$STATUS_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$STATUS_RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
              echo "Status check failed with HTTP code: $HTTP_CODE"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
            
            # Extract status from JSON response
            STATUS=$(echo "$RESPONSE_BODY" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "")
            
            if [ "$STATUS" = "Succeeded" ]; then
              echo "Upload completed successfully"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Upload failed"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Upload in progress (attempt $RETRY_COUNT/$MAX_RETRIES). Status: ${STATUS:-InProgress}. Waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Upload status check timed out after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Publish submission to Edge Add-ons Store
        id: publish_submission
        run: |
          API_ENDPOINT="https://api.addons.microsoftedge.microsoft.com"
          PRODUCT_ID="${{ secrets.EDGE_PRODUCT_ID }}"
          CLIENT_ID="${{ secrets.EDGE_CLIENT_ID }}"
          API_KEY="${{ secrets.EDGE_API_KEY }}"
          RELEASE_NOTES="${{ github.event.inputs.release_notes || 'Bug fixes and improvements' }}"
          
          # Create JSON with proper escaping using printf
          NOTES_JSON=$(printf '{"notes":"%s"}' "$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')")
          
          echo "Publishing submission to Edge Add-ons Store..."
          # Use -i to include headers, -w to append HTTP code
          PUBLISH_RESPONSE=$(curl -i -s -w "\nHTTP_CODE:%{http_code}" \
            -X POST \
            -H "Authorization: ApiKey $API_KEY" \
            -H "X-ClientID: $CLIENT_ID" \
            -H "Content-Type: application/json" \
            -d "$NOTES_JSON" \
            "$API_ENDPOINT/v1/products/$PRODUCT_ID/submissions")
          
          HTTP_CODE=$(echo "$PUBLISH_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          LOCATION_HEADER=$(echo "$PUBLISH_RESPONSE" | grep -i "^location:" | cut -d' ' -f2 | tr -d '\r\n')
          
          if [ "$HTTP_CODE" != "202" ]; then
            echo "Publish failed with HTTP code: $HTTP_CODE"
            echo "Response: $PUBLISH_RESPONSE"
            exit 1
          fi
          
          # Extract operation ID from Location header
          if [ -z "$LOCATION_HEADER" ]; then
            echo "Failed to extract Location header from response"
            echo "Response: $PUBLISH_RESPONSE"
            exit 1
          fi
          
          PUBLISH_OPERATION_ID=$(echo "$LOCATION_HEADER" | sed 's/.*\/\([^\/]*\)$/\1/')
          if [ -z "$PUBLISH_OPERATION_ID" ]; then
            echo "Failed to extract publish operation ID from Location header: $LOCATION_HEADER"
            exit 1
          fi
          
          echo "publish_operation_id=$PUBLISH_OPERATION_ID" >> $GITHUB_OUTPUT
          echo "Publish initiated successfully. Operation ID: $PUBLISH_OPERATION_ID"

      - name: Check publishing status
        id: check_publish_status
        run: |
          API_ENDPOINT="https://api.addons.microsoftedge.microsoft.com"
          PRODUCT_ID="${{ secrets.EDGE_PRODUCT_ID }}"
          CLIENT_ID="${{ secrets.EDGE_CLIENT_ID }}"
          API_KEY="${{ secrets.EDGE_API_KEY }}"
          OPERATION_ID="${{ steps.publish_submission.outputs.publish_operation_id }}"
          
          echo "Checking publishing status..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          RETRY_DELAY=5
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            STATUS_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X GET \
              -H "Authorization: ApiKey $API_KEY" \
              -H "X-ClientID: $CLIENT_ID" \
              "$API_ENDPOINT/v1/products/$PRODUCT_ID/submissions/operations/$OPERATION_ID")
            
            HTTP_CODE=$(echo "$STATUS_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$STATUS_RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "202" ]; then
              echo "Status check failed with HTTP code: $HTTP_CODE"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
            
            # Extract status from JSON response
            STATUS=$(echo "$RESPONSE_BODY" | grep -o '"status":"[^"]*"' | cut -d'"' -f4 || echo "")
            
            if [ "$STATUS" = "Succeeded" ]; then
              echo "Publishing completed successfully"
              break
            elif [ "$STATUS" = "Failed" ]; then
              echo "Publishing failed"
              echo "Response: $RESPONSE_BODY"
              exit 1
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Publishing in progress (attempt $RETRY_COUNT/$MAX_RETRIES). Status: ${STATUS:-InProgress}. Waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "Publishing status check timed out after $MAX_RETRIES attempts"
            exit 1
          fi
          
          echo "Extension successfully published to Edge Add-ons Store!"

